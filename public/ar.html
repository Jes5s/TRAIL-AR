<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IronLinks AR Viewer</title>

  <!-- model-viewer (stable) -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    body { margin:0; font-family:system-ui, Roboto, Arial; display:flex; flex-direction:column; min-height:100vh; }
    header { padding:12px; background:#111; color:white; text-align:center; }
    main { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; padding:12px; }
    .viewer-wrap { width:100%; max-width:900px; aspect-ratio: 16/9; background:#000; border-radius:10px; overflow:hidden; display:flex; }
    model-viewer { width:100%; height:100%; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    .notice { color:#666; font-size:14px; text-align:center; max-width:800px; }
    .error { color:crimson; font-weight:600; }
    a.btn { background:#1976d2; color:white; padding:8px 14px; border-radius:8px; text-decoration:none; }
  </style>
</head>
<body>
  <header>
    <h1>IronLinks — AR Viewer</h1>
  </header>

  <main>
    <div class="viewer-wrap" id="viewerWrap">
      <!-- model-viewer will be inserted here dynamically -->
      <div id="loader" style="color:#ddd;display:flex;align-items:center;justify-content:center;width:100%;">Preparing AR viewer…</div>
    </div>

    <div class="controls" id="controls"></div>
    <p class="notice">
      Use your phone camera to view the model in your space. If AR fails to open, try the direct links shown below.
    </p>

    <div id="fallbackLinks" style="text-align:center;"></div>
    <p id="status" class="notice"></p>
  </main>

  <script>
    // --- Configuration: map model keys to actual filenames (in /models)
    const MODEL_REGISTRY = {
      "wall": { glb: "/models/wall.glb", usdz: "/models/wall.usdz", label: "Wall (placeholder)" },
      // future: "gate1": { glb: "/models/gate1.glb", usdz: "/models/gate1.usdz", label: "Gate A" },
      // add more entries as you upload models to /public/models/
    };

    // Utility: get ?model=name (default 'wall')
    function getQueryParam(name, defaultVal) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name) || defaultVal;
    }

    // detect iOS QuickLook support (iPhone/iPad Safari)
    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }

    // build scene-viewer intent (Android) as fallback link
    function buildSceneViewerIntent(gltfUrl, fallbackUrl) {
      // safe-encoded urls
      const file = encodeURIComponent(gltfUrl);
      const fallback = encodeURIComponent(fallbackUrl);
      return `intent://arvr.google.com/scene-viewer/1.0?file=${file}&mode=ar_preferred#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;S.browser_fallback_url=${fallback};end`;
    }

    // main
    (function(){
      const modelKey = getQueryParam('model','wall');
      const entry = MODEL_REGISTRY[modelKey];

      const status = document.getElementById('status');
      const viewerWrap = document.getElementById('viewerWrap');
      const fallbackLinks = document.getElementById('fallbackLinks');
      const controls = document.getElementById('controls');

      if (!entry) {
        status.innerHTML = `<span class="error">Model "${modelKey}" not found in registry.</span> Add it to MODEL_REGISTRY in ar.html and upload the files to /public/models/.`;
        document.getElementById('loader').style.display = 'none';
        return;
      }

      // create a <model-viewer> element
      const mv = document.createElement('model-viewer');
      mv.setAttribute('alt', entry.label || modelKey);
      mv.setAttribute('camera-controls','');
      mv.setAttribute('ar',''); // enable AR
      mv.setAttribute('reveal','interaction'); // or 'auto'
      mv.style.backgroundColor = '#000';

      // src and ios-src
      mv.src = entry.glb;
      if (entry.usdz) mv.setAttribute('ios-src', entry.usdz);

      // accessibility / poster / loading
      mv.setAttribute('loading','eager');

      // append
      viewerWrap.innerHTML = ""; // remove loader
      viewerWrap.appendChild(mv);

      // Show direct fallback links (Quick Look and Scene Viewer)
      const absoluteGLB = new URL(entry.glb, window.location.href).href;
      const absoluteUSDZ = entry.usdz ? new URL(entry.usdz, window.location.href).href : null;

      // Quick Look link for iOS (just the .usdz)
      if (absoluteUSDZ) {
        const ql = document.createElement('a');
        ql.href = absoluteUSDZ;
        ql.rel = "ar";
        ql.innerText = "Open in Quick Look (iOS)";
        ql.className = "btn";
        ql.style.marginRight = "8px";
        fallbackLinks.appendChild(ql);
      }

      // Scene Viewer (Android intent)
      const sceneIntent = buildSceneViewerIntent(absoluteGLB, window.location.href);
      const sceneBtn = document.createElement('a');
      sceneBtn.href = sceneIntent;
      sceneBtn.innerText = "Open in Scene Viewer (Android)";
      sceneBtn.className = "btn";
      fallbackLinks.appendChild(sceneBtn);

      // small control area showing which files will be used
      controls.innerHTML = `<div style="font-size:13px;color:#444">Model: <strong>${modelKey}</strong> — GLB: <code>${absoluteGLB}</code>${absoluteUSDZ ? `<br> USDZ: <code>${absoluteUSDZ}</code>` : ''}</div>`;

      // error handling to show useful messages
      mv.addEventListener('error', (ev) => {
        console.error('model-viewer error', ev);
        status.innerHTML = `<span class="error">Failed to load model. Check that the files exist, are valid, and are publicly accessible (404/CORS/MIME). See console for details.</span>`;
      });

      mv.addEventListener('load', () => {
        status.innerText = "Model loaded. Tap the AR button (if present) to view in your space.";
      });

    })();
  </script>
</body>
</html>
